services:
  "itemizebi/api:2.13.1":
    network_mode: host
    restart: "on-failure"
    env_file:
    - ./infra.secrets.env
    depends_on:
    - sidecar
    - broker
    - cache
    - mongodb
    - worker
    - loki
    environment:
    - FLOW_LOGGER_NAME=WEB
    - PYTHONUNBUFFERED=1
    - PYTHONBREAKPOINT=0
    - TERM=xterm-256color
    instances:
      api1:
        environment:
        - APP_PORT=8001
        command: bash -c " uvicorn --loop uvloop \ --host 0.0.0.0 \ --port 8001 \ 
          --log-level info \ --timeout-keep-alive 3600 \ app_asgi:app"

      api2:
        environment:
        - APP_PORT=8002
        command: bash -c " uvicorn --loop uvloop \ --host 0.0.0.0 \ --port 8002 \ 
          --log-level info \ --timeout-keep-alive 3600 \ app_asgi:app"

      api3:
        environment:
        - APP_PORT=8003
        command: bash -c " uvicorn --loop uvloop \ --host 0.0.0.0 \ --port 8003 \ 
          --log-level info \ --timeout-keep-alive 3600 \ app_asgi:app"

      api4:
        environment:
        - APP_PORT=8004
        command: bash -c " uvicorn --loop uvloop \ --host 0.0.0.0 \ --port 8004 \ 
          --log-level info \ --timeout-keep-alive 3600 \ app_asgi:app"

  "itemizebi/sidecar:2.13.1":
    instances:
      sidecar:
        network_mode: host
        restart: "on-failure"
        env_file:
        - ./infra.secrets.env
        volumes:
        - ./src:/home/itemize/flow/src
        environment:
        - APP_PORT=8020
        - FLOW_LOGGER_NAME=WEB
        - PYTHONUNBUFFERED=1
        - PYTHONBREAKPOINT=0
        - TERM=xterm-256color
        depends_on:
        - broker
        - cache
        - mongodb
        - worker
        - loki
        command: bash -c " uvicorn --loop uvloop \ --host 0.0.0.0 \ --port 8020 \ 
          --log-level info \ --timeout-keep-alive 3600 \ app_sidecar:app"

  "itemizebi/scheduler:2.13.1":
    instances:
      scheduler:
        network_mode: host
        restart: "on-failure"
        volumes:
        - ./src:/home/itemize/flow/src
        env_file:
        - ./infra.secrets.env
        environment:
        - FLOW_LOGGER_NAME=SCHEDULER
        depends_on:
        - loki
        - mongodb
        - broker
        - worker

  "itemizebi/worker:2.13.1":
    instances:
      worker:
        network_mode: host
        restart: "always"
        env_file:
        - ./infra.secrets.env
        depends_on:
        - broker
        - loki
        environment:
        - FLOW_LOGGER_NAME=ORCAMENTO_WORKER
        command: python app_worker.py

  "itemizebi/overhead:2.13.1":
    instances:
      overhead:
        network_mode: host
        restart: "on-failure"
        command: bash -c " uvicorn \ --host 0.0.0.0 \ --loop uvloop \ --port 5000 \ 
          --log-level info \ --timeout-keep-alive 3600 \ app_overhead:app"

infra:
  "mysql:8.0.43":
    instances:
      mysql:
        restart: unless-stopped
        env_file:
        - ./infra.secrets.env
        network_mode: host
        volumes:
        - ./sqls/mysql-init:/docker-entrypoint-initdb.d
        - mysql_data:/var/lib/mysql
        - ./backup.prod.sql:/backup.prod.sql

        healthcheck:
          test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
          interval: 10s
          timeout: 5s
          retries: 5

  "redis:6.2-alpine":
    instances:
      cache:
        network_mode: host
        restart: always
        mem_limit: 256m
        volumes:
        - cache:/data
        environment:
        - REDIS_MAXMEMORY=256m

  "rabbitmq:3-management":
    instances:
      broker: # ports 15672, 5672, 25672
        network_mode: host
        volumes:
        - /docker_conf/rabbitmq/data/:/var/lib/rabbitmq/
        env_file:
        - ./infra.secrets.env
        restart: always

  "mongo:4.4":
    instances:
      mongodb:
        network_mode: host
        env_file:
        - ./infra.secrets.env
        volumes:
        - mongodb-data:/data/db   # Persistência dos dados
        - mongodb-logs:/var/log/mongodb   # Persistência dos logs (opcional)

  "prom/prometheus":
    instances:
      prometheus:
        # ports:
        #   - "9090:9090"
        network_mode: host
        restart: unless-stopped
        volumes:
        - ./conf/prometheus.yml:/etc/prometheus/prometheus.yml
        - prometheus-data:/prometheus

  "grafana/loki:3.4.2":
    instances:
      loki:
        restart: unless-stopped
        ports:
        - "3111:3111"
        volumes:
        - ./conf/loki.yaml:/etc/loki/loki.yaml
        - loki-data:/var/loki
        environment:
        - LOKI_CONFIG_FILE=/etc/loki/loki.yaml
        command: -config.file=/etc/loki/loki.yaml

  "grafana/grafana:11.5.2":
    instances:
      ports:
      - "3000:3000"
      environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      depends_on:
      - loki
      restart: unless-stopped
      volumes:
      - grafana-data:/var/lib/grafana

volumes:
  mysql_data:
  cache:
  loki-data:
  grafana-data:
  mongodb-data:
  mongodb-logs:
  prometheus-data:
  zookeeper_data:
  kafka_data:

networks:
  default:
    name: flow_network
    driver: bridge
